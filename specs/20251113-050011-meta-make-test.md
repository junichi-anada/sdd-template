# Spec: meta: make test にシェルテストを統合

## 概要
- 課題: 現在 `make test` は PHP(Laravel) の PHPUnit 実行か composer 経由のみであり、既存のシェルベース回帰テスト (`tests/meta_spec_generation.sh` など) が自動で走らず、メタ機能やジェネレータ変更のリグレッション検知ができない。
- 目的: `make test` にシェルテスト群を統合し、PHP テストが存在しない/失敗/成功する各ケースでシェルテストも一貫して検証される仕組みを提供する。メタ変更を含む PR で抜け漏れなく回帰検出できる安全網を強化する。
- スコープ: `tests/**/*.sh` の収集と逐次/並列実行。テスト出力の集約。終了コードのポリシー定義。CI ローカル(`make ci-local`) からも利用。
- アウトオブスコープ: sh 以外言語のテスランナー統合 (bats, pytest 等)、高度な並列最適化、JUnit XML 変換、GitHub Actions ワークフロー変更。

## コンテキスト
- 背景: メタ仕様導入後もスクリプト変更は頻発する見込み。現状シェルテストは手動 invocation 前提で自動化がなく、破壊的変更検知が運に左右される。
- 利用者/ロール: コントリビュータ(仕様/計画/スクリプト修正)、レビュアー(PR チェック)、CI 実行環境(自動判定)。
- 前提条件: Bash 5+ が利用可能。`tests/` 下に信頼できるテストシェルスクリプトは `set -euo pipefail` を利用し終了コードで成否を返す。PHP/Laravel 部分は存在しない可能性がある。

## ユースケース / シナリオ
| シナリオID | タイトル | アクター | 概要 | 成功条件 |
|------------|----------|---------|------|----------|
| UC-1 | シェルテストのみのリポジトリで `make test` 実行 | コントリビュータ | PHP が無い状態でもシェルテストが走る | 全シェルテスト成功し exit code 0 |
| UC-2 | Laravel + シェルテスト混在で `make test` 実行 | コントリビュータ | PHPUnit 後にシェルテストも実行 | PHPUnit/シェル共に成功で 0 |
| UC-3 | シェルテストの一つが失敗 | コントリビュータ | 失敗したテスト名が表示される | 失敗名列挙+非ゼロ終了 |
| UC-4 | PHPUnit 失敗だがシェル全成功 | CI | まず PHPUnit 失敗を通知後シェルも走る | 全結果集約し非ゼロ終了 |
| UC-5 | テストスクリプトが executable でない | CI | 実行対象から除外し警告表示 | 警告出力し他は続行 |

## 機能要件
| 要件ID | 区分(FUNC/NONFUNC) | 内容 | 優先度(H/M/L) |
|--------|--------------------|------|---------------|
| FR-1 | FUNC | `make test` にシェルテスト実行ステップを追加 | H |
| FR-2 | FUNC | `tests/**/*.sh` をグロブ収集し昇順で実行 | M |
| FR-3 | FUNC | 個別テストの開始/成功/失敗ログを標準出力整形表示 | M |
| FR-4 | FUNC | 失敗テストが存在すれば最終 exit code は >0 | H |
| FR-5 | FUNC | PHPUnit が存在しない場合は警告のみで継続 | M |
| FR-6 | FUNC | PHPUnit 失敗時もシェルテストは走り結果を集約 | M |
| FR-7 | NONFUNC | 実行時間はシェルテスト総数 * O(1); 追加オーバーヘッド最小 | L |
| FR-8 | FUNC | 未実行(非実行権限)スクリプトはスキップし警告 | L |

## 非機能要件
- パフォーマンス: シェルテストは短時間前提。総時間 < 5s を目安 (将来並列化余地)。
- セキュリティ: 任意コード実行リスク→`tests/` へのレビュー徹底。外部ネットワークコールは最小化するガイドライン追加予定。
- 可観測性: 標準出力ログのみ。失敗一覧を最後にサマリ表示。
- 運用: 追加依存無し。既存 CI 呼び出し (`make test`) に透過的統合。

## 受け入れ基準
| 基準ID | 条件 | 検証方法 |
|--------|------|----------|
| AC-1 | `make test` で PHPUnit 無→シェルテスト成功→exit 0 | ローカル実行確認 |
| AC-2 | `make test` で シェルテスト1件失敗→exit >0 かつ失敗名出力 | ローカル/CI |
| AC-3 | PHPUnit 失敗+シェル成功→全体 exit は非ゼロ | ローカル/CI |
| AC-4 | 非実行権限テストは警告行を出力 | ローカル |
| AC-5 | 既存 `tests/meta_spec_generation.sh` が自動実行される | ローカル |
| AC-6 | 並列無し (順次) 実装で性能問題が無い | 計測 (<5s) |

## リスク / 未決事項
| ID | 種類(RISK/OPEN) | 内容 | 対応/期日 |
|----|-----------------|------|-----------|
| R-1 | RISK | テスト総数増加による遅延 | 現状許容/閾値監視 |
| R-2 | RISK | 失敗時に PHPUnit 結果が埋もれる | 出力セクション分離 (=== PHPUnit === / === Shell ===) |
| O-1 | OPEN | 将来 JUnit XML 出力要望 | 次フェーズ検討 |
| O-2 | OPEN | 並列実行 (xargs -P) の導入 | 成果/必要性評価後 |

## 変更影響
- 影響範囲: `Makefile` / `scripts/test.sh` / 新規ヘルパー(必要なら) のみ。既存 spec/plan テンプレート非変更。
- 互換性: 従来 `make test` の成功条件を拡張 (PHP テスト無→シェルのみ)。既存利用者への破壊的変更は無し。

## 承認
- Draft 作成者: GitHub Copilot Agent
- レビュー: Owner
- 承認日時: 2025-11-13T00:00:00+09:00
- ステータス: APPROVED
